# ============================================================================
# Nia LeSane 5.0 - Monorepo Deployment Script (PowerShell)
# Owner: jazzu72 | House of Jazzu LLC
# ============================================================================

$ErrorActionPreference = "Stop"

# Colors
$Green = [System.ConsoleColor]::Green
$Yellow = [System.ConsoleColor]::Yellow
$Red = [System.ConsoleColor]::Red
$Cyan = [System.ConsoleColor]::Cyan
$Magenta = [System.ConsoleColor]::Magenta

function Write-Step {
    param([string]$Message)
    Write-Host "â–¶ $Message" -ForegroundColor $Cyan
}

function Write-Success {
    param([string]$Message)
    Write-Host "âœ“ $Message" -ForegroundColor $Green
}

function Write-Fail {
    param([string]$Message)
    Write-Host "âœ— $Message" -ForegroundColor $Red
}

function Write-Warn {
    param([string]$Message)
    Write-Host "âš  $Message" -ForegroundColor $Yellow
}

Clear-Host

Write-Host @"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘         ğŸ­  NIA LESANE 5.0 - MONOREPO DEPLOYMENT  ğŸ­      â•‘
â•‘                                                           â•‘
â•‘              House of Jazzu | Owner: jazzu72             â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

"@ -ForegroundColor $Magenta

# ============================================================================
# STEP 1: VERIFY PROJECT STRUCTURE
# ============================================================================

Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 1: Verifying Monorepo Structure" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Checking current directory..."
$currentDir = Get-Location
Write-Host "Current location: $currentDir"

# Check for monorepo structure
$requiredDirs = @("apps", "infra", ".github")
$missingDirs = @()

foreach ($dir in $requiredDirs) {
    if (-not (Test-Path $dir)) {
        $missingDirs += $dir
    }
}

if ($missingDirs.Count -gt 0) {
    Write-Fail "Not in Nia-LeSane-5.0 root directory!"
    Write-Host "`nMissing directories:"
    foreach ($dir in $missingDirs) {
        Write-Host "  - $dir"
    }
    Write-Host "`nPlease navigate to your project root:"
    Write-Host "  cd C:\path\to\Nia-LeSane-5.0" -ForegroundColor $Yellow
    exit 1
}

Write-Success "Verified monorepo structure"

# Check for required files
Write-Step "Checking required files..."
$requiredFiles = @("vercel.json", "README.md", "OWNER.md")
$missingFiles = @()

foreach ($file in $requiredFiles) {
    if (-not (Test-Path $file)) {
        $missingFiles += $file
    }
}

if ($missingFiles.Count -gt 0) {
    Write-Warn "Missing files:"
    foreach ($file in $missingFiles) {
        Write-Host "  - $file"
    }
}
else {
    Write-Success "All required files present"
}

# ============================================================================
# STEP 2: CHECK APPLICATIONS
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 2: Checking Applications" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

# Check web app
Write-Step "Checking apps/web..."
if (Test-Path "apps/web/package.json") {
    Write-Success "Next.js app found"
    
    # Check if node_modules exists
    if (-not (Test-Path "apps/web/node_modules")) {
        Write-Warn "Dependencies not installed. Run: cd apps/web && npm install"
    }
}
else {
    Write-Warn "apps/web/package.json not found"
}

# Check API app
Write-Step "Checking apps/api..."
if (Test-Path "apps/api/src/main.py") {
    Write-Success "FastAPI app found"
    
    # Check for requirements.txt
    if (Test-Path "apps/api/requirements.txt") {
        Write-Success "requirements.txt found"
    }
}
else {
    Write-Warn "apps/api/src/main.py not found"
}

# ============================================================================
# STEP 3: VERCEL CLI CHECK
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 3: Vercel CLI Setup" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Checking Vercel CLI..."
$vercelInstalled = Get-Command vercel -ErrorAction SilentlyContinue

if (-not $vercelInstalled) {
    Write-Warn "Vercel CLI not found. Installing..."
    npm install -g vercel
    Write-Success "Vercel CLI installed"
}
else {
    Write-Success "Vercel CLI installed"
}

Write-Step "Checking Vercel authentication..."
$vercelUser = vercel whoami 2>$null

if ($LASTEXITCODE -ne 0) {
    Write-Warn "Not logged in to Vercel. Please login:"
    vercel login
    $vercelUser = vercel whoami
}

Write-Success "Logged in as: $vercelUser"

# ============================================================================
# STEP 4: PROJECT LINKING
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 4: Project Linking" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Checking Vercel project link..."
if (Test-Path ".vercel/project.json") {
    $projectInfo = Get-Content ".vercel/project.json" | ConvertFrom-Json
    Write-Success "Project linked: $($projectInfo.name)"
}
else {
    Write-Warn "Project not linked. Linking now..."
    Write-Host "`nSelect these options:" -ForegroundColor $Yellow
    Write-Host "  - Set up and deploy? Yes"
    Write-Host "  - Scope: jazzu72's projects"
    Write-Host "  - Link to existing? No (create new)"
    Write-Host "  - Project name: nia-lesane`n"
    
    vercel link
    
    if ($LASTEXITCODE -eq 0) {
        Write-Success "Project linked successfully"
    }
    else {
        Write-Fail "Project linking failed"
        exit 1
    }
}

# ============================================================================
# STEP 5: ENVIRONMENT VARIABLES
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 5: Environment Variables" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Checking environment variables..."

$criticalVars = @(
    "SPECIAL_PASSWORD",
    "VAULT_ENCRYPTION_KEY",
    "STRIPE_WEBHOOK_SECRET",
    "TELEGRAM_BOT_TOKEN"
)

$envOutput = vercel env ls production 2>&1
$missingVars = @()

foreach ($var in $criticalVars) {
    if ($envOutput -notmatch $var) {
        $missingVars += $var
    }
}

if ($missingVars.Count -gt 0) {
    Write-Warn "Missing environment variables:"
    foreach ($var in $missingVars) {
        Write-Host "  - $var"
    }
    Write-Host "`nAdd them with:" -ForegroundColor $Yellow
    Write-Host "  vercel env add <VAR_NAME> production`n"
    
    $continue = Read-Host "Continue deployment without these? (yes/no)"
    if ($continue -ne "yes") {
        Write-Host "Deployment cancelled." -ForegroundColor $Red
        exit 0
    }
}
else {
    Write-Success "All critical environment variables configured"
}

# ============================================================================
# STEP 6: GIT STATUS
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 6: Git Status Check" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Checking git status..."
$gitStatus = git status --porcelain

if ($gitStatus) {
    Write-Warn "You have uncommitted changes:"
    Write-Host ""
    git status --short
    Write-Host ""
    
    $commitNow = Read-Host "Commit and push changes? (yes/no)"
    
    if ($commitNow -eq "yes") {
        git add -A
        
        $commitMsg = Read-Host "Enter commit message (or press Enter for default)"
        if (-not $commitMsg) {
            $commitMsg = "ğŸš€ Production deployment - $(Get-Date -Format 'yyyy-MM-dd HH:mm')"
        }
        
        git commit -m "$commitMsg`n`nOwner: jazzu72`nDeployed: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
        
        Write-Step "Pushing to GitHub..."
        $currentBranch = git branch --show-current
        git push origin $currentBranch
        
        Write-Success "Changes committed and pushed"
    }
}
else {
    Write-Success "Working directory clean"
}

# ============================================================================
# STEP 7: BUILD TEST
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 7: Build Verification" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Testing build..."
Write-Host "Running: vercel build" -ForegroundColor $Yellow

$buildOutput = vercel build 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Success "Build test passed"
}
else {
    Write-Warn "Build test had warnings (may still deploy successfully)"
}

# ============================================================================
# STEP 8: DEPLOYMENT CONFIRMATION
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 8: Final Confirmation" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Host @"
âš ï¸  FINAL LAUNCH CHECKLIST âš ï¸

You are about to deploy Nia LeSane 5.0 to PRODUCTION.

This will deploy:
  â€¢ Next.js PWA (apps/web)
  â€¢ FastAPI backend (apps/api)
  â€¢ Governance system
  â€¢ Stripe webhooks
  â€¢ Telegram integration

Project: Nia LeSane 5.0
Owner: jazzu72
Organization: House of Jazzu LLC

"@ -ForegroundColor $Yellow

$confirm = Read-Host "Type 'LAUNCH' to proceed"

if ($confirm -ne "LAUNCH") {
    Write-Host "`nDeployment cancelled." -ForegroundColor $Red
    exit 0
}

# ============================================================================
# STEP 9: DEPLOY
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 9: Deploying to Production" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Starting production deployment..."
Write-Host ""

vercel --prod --yes

if ($LASTEXITCODE -eq 0) {
    Write-Success "Deployment successful!"
}
else {
    Write-Fail "Deployment failed. Check errors above."
    exit 1
}

# Get deployment URL
$deploymentUrl = vercel inspect --prod 2>&1 | Select-String "https://" | Select-Object -First 1

if (-not $deploymentUrl) {
    $deploymentUrl = "https://nia-lesane.vercel.app"
}

# ============================================================================
# STEP 10: POST-DEPLOYMENT VERIFICATION
# ============================================================================

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Magenta
Write-Host "STEP 10: Post-Deployment Verification" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Magenta

Write-Step "Waiting for deployment to propagate..."
Start-Sleep -Seconds 5

Write-Step "Testing health endpoint..."
try {
    $response = Invoke-WebRequest -Uri "$deploymentUrl/api" -Method Get -UseBasicParsing
    if ($response.StatusCode -eq 200) {
        Write-Success "API health check passed"
    }
}
catch {
    Write-Warn "API health check returned: $($_.Exception.Response.StatusCode)"
}

# ============================================================================
# SUCCESS OUTPUT
# ============================================================================

Write-Host "`n" -NoNewline
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Green
Write-Host "ğŸ‰ DEPLOYMENT COMPLETE! ğŸ‰" -ForegroundColor $Green
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Green

Write-Host "Your Nia LeSane platform is now LIVE at:" -ForegroundColor $Cyan
Write-Host "$deploymentUrl`n" -ForegroundColor $Yellow

Write-Host "Access Points:" -ForegroundColor $Cyan
Write-Host "  ğŸ­ Main Dashboard:   $deploymentUrl/"
Write-Host "  ğŸ“‹ Proposals UI:     $deploymentUrl/proposals"
Write-Host "  ğŸ“š API Docs:         $deploymentUrl/api/docs"
Write-Host "  ğŸ’° Vault Balance:    $deploymentUrl/api/vault/balance`n"

Write-Host "âš ï¸  CRITICAL NEXT STEPS:`n" -ForegroundColor $Yellow

Write-Host "1. Configure Stripe Webhook:" -ForegroundColor $Cyan
Write-Host "   â†’ https://dashboard.stripe.com/webhooks"
Write-Host "   â†’ Add endpoint: $deploymentUrl/webhook/stripe`n"

Write-Host "2. Update Telegram Bot:" -ForegroundColor $Cyan
Write-Host "   Invoke-WebRequest -Uri 'https://api.telegram.org/bot<TOKEN>/setWebhook' -Method Post -Body @{url='$deploymentUrl/webhook/telegram'}`n"

Write-Host "3. Test Ritual Invocation:" -ForegroundColor $Cyan
Write-Host "   Invoke-WebRequest -Uri '$deploymentUrl/api/invoke' -Method Post -ContentType 'application/json' -Body '{`"ritual_type`": `"morning_alignment`", `"special_password`": `"AddieMaeLeSane33`"}'`n"

Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor $Green
Write-Host "Owner: jazzu72 | House of Jazzu LLC" -ForegroundColor $Magenta
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor $Green

Write-Host @"
         ğŸ­ WHERE RITUAL MEETS RIGOR ğŸ­
              AND JAZZ MEETS FINANCE

         Built with soul by jazzu72
              House of Jazzu LLC
"@ -ForegroundColor $Magenta

# Save deployment info
$deploymentInfo = @"
Nia LeSane 5.0 - Production Deployment
=======================================

Deployment Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
Deployment URL: $deploymentUrl
Owner: jazzu72
Organization: House of Jazzu LLC
Vercel User: $vercelUser

Status: LIVE âœ…

Architecture: Monorepo
- Frontend: Next.js 14 (apps/web)
- Backend: FastAPI (apps/api)
- Infrastructure: Terraform (infra/)

Next Steps:
1. Configure Stripe webhook
2. Update Telegram bot webhook
3. Test ritual invocation
4. Monitor logs: vercel logs --follow

For support: github.com/jazzu72/Nia-LeSane-5.0
"@

$deploymentInfo | Out-File -FilePath "DEPLOYMENT_INFO.txt" -Encoding UTF8
Write-Success "Deployment info saved to DEPLOYMENT_INFO.txt"

Write-Host "`nğŸš€ Launch complete! The world awaits Nia LeSane.`n" -ForegroundColor $Green
